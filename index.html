<!-- This work is licensed under the W3C Software and Document License
     (http://www.w3.org/Consortium/Legal/2015/copyright-software-and-document).
  -->
<!DOCTYPE html>
<html>

<head>
    <title>
        Web Share Test
    </title>
    <meta name="viewport" content="width=device-width">
    <style>
        .error {
            color: #d22;
        }

        input[type="button"] {
            height: 30px
        }
    </style>
</head>

<body>
    <h1>
        Web Share Test
    </h1>
    <table>
        <tr>
            <td>
                Files:
            </td>
            <td>
                <!--Without column 2, the whole table is small on mobile.-->
            </td>
            <td>
                <input id="files" type="file" multiple>
            </td>
        </tr>
    </table>
    <p>
        <input id="share" type="button" value="Share">
    </p>
    <div id="output"></div>
    <script>
        'use strict';

        function sleep(delay) {
            return new Promise(resolve => {
                setTimeout(resolve, delay);
            });
        }

        function logText(message, isError) {
            if (isError)
                console.error(message);
            else
                console.log(message);

            const p = document.createElement('p');
            if (isError)
                p.setAttribute('class', 'error');
            document.querySelector('#output').appendChild(p);
            p.appendChild(document.createTextNode(message));
        }

        function logError(message) {
            logText(message, true);
        }

        function setShareButtonsEnabled(enabled) {
            document.querySelector('#share').disabled = !enabled;
        }

        function checkboxChanged(e) {
            const checkbox = e.target;
            const textfield = document.querySelector('#' + checkbox.id.split('_')[0]);

            textfield.disabled = !checkbox.checked;
            if (!checkbox.checked)
                textfield.value = '';
        }

        function checkBasicFileShare() {
            // XXX: There is no straightforward API to do this.
            // For now, assume that text/plain is supported everywhere.
            const txt = new Blob(['Hello, world!'], { type: 'text/plain' });
            // XXX: Blob support? https://github.com/w3c/web-share/issues/181
            const file = new File([txt], "test.txt");
            return navigator.canShare({ files: [file] });
        }

        async function testWebShare() {
            const file_input = document.querySelector('#files');
            const files = file_input.disabled ? undefined : file_input.files;

            if (files && files.length > 0) {
                if (!navigator.canShare) {
                    logError('Warning: canShare is not supported. File sharing may not be supported at all.');
                } else if (!checkBasicFileShare()) {
                    logError('Error: File sharing is not supported in this browser.');
                    setShareButtonsEnabled(true);
                    return;
                } else if (!navigator.canShare({ files })) {
                    logError('Error: share() does not support the given files');
                    for (const file of files) {
                        logError(`File info: name - ${file.name}, size ${file.size}, type ${file.type}`);
                    }
                    setShareButtonsEnabled(true);
                    return;
                }
            }

            setShareButtonsEnabled(false);
            try {
                await navigator.share({
                    files, title: 'Thông báo giao dịch',
                    text: 'Chia sẻ thông báo giao dịch'
                });
                logText('Successfully sent share');
            } catch (error) {
                logError('Error sharing: ' + error);
            }
            setShareButtonsEnabled(true);
        }

        async function testWebShareDelay() {
            setShareButtonsEnabled(false);
            await sleep(6000);
            testWebShare();
        }

        function onLoad() {
            document.querySelector('#share').addEventListener('click', testWebShare);
            if (navigator.share === undefined) {
                setShareButtonsEnabled(false);
                if (window.location.protocol === 'http:') {
                    // navigator.share() is only available in secure contexts.
                    window.location.replace(window.location.href.replace(/^http:/, 'https:'));
                } else {
                    logError('Error: You need to use a browser that supports this draft ' +
                        'proposal.');
                }
            }
        }

        window.addEventListener('load', onLoad);
    </script>
</body>

</html>
